<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kasir Online - Pembelian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Pembelian / Stok Masuk</span>
    <a class="btn btn-sm btn-light" href="index.html">Kembali</a>
  </div>
</nav>

<main class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header fw-bold">Input Pembelian</div>
    <div class="card-body">
      <form id="formPembelian">
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Supplier</label>
            <input type="text" name="supplier_name" class="form-control" placeholder="Nama supplier (opsional)" />
          </div>
          <div class="col-md-8">
            <label class="form-label">Catatan</label>
            <input type="text" name="note" class="form-control" placeholder="Catatan pembelian (opsional)" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center" id="tblItems">
            <thead class="table-light">
              <tr>
                <th>SKU</th>
                <th>Nama Produk</th>
                <th>Qty</th>
                <th>Harga</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <button type="button" class="btn btn-outline-primary btn-sm" id="btnAdd">+ Tambah Item</button>
        <hr />
        <div class="d-flex justify-content-between">
          <h5>Total: <span id="totalText">Rp 0</span></h5>
          <button type="submit" class="btn btn-primary">Simpan Pembelian</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header fw-bold">Riwayat Pembelian Hari Ini</div>
    <div class="card-body">
      <div id="riwayat"></div>
    </div>
  </div>
</main>

<script>
const tbody = document.querySelector('#tblItems tbody');
const btnAdd = document.getElementById('btnAdd');
const totalText = document.getElementById('totalText');

function formatRupiah(n) {
  return 'Rp ' + n.toLocaleString('id-ID');
}

btnAdd.addEventListener('click', () => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class='form-control form-control-sm sku' placeholder='SKU'></td>
    <td><input class='form-control form-control-sm name' placeholder='Nama'></td>
    <td><input type='number' min='1' class='form-control form-control-sm qty' value='1'></td>
    <td><input type='number' min='0' class='form-control form-control-sm price' value='0'></td>
    <td class='subtotal'>Rp 0</td>
    <td><button type='button' class='btn btn-danger btn-sm btnDel'>&times;</button></td>
  `;
  tbody.appendChild(tr);
  updateTotal();
});

tbody.addEventListener('input', e => {
  if (e.target.classList.contains('qty') || e.target.classList.contains('price')) {
    const tr = e.target.closest('tr');
    const qty = parseFloat(tr.querySelector('.qty').value) || 0;
    const price = parseFloat(tr.querySelector('.price').value) || 0;
    const subtotal = qty * price;
    tr.querySelector('.subtotal').textContent = formatRupiah(subtotal);
    updateTotal();
  }
});

tbody.addEventListener('click', e => {
  if (e.target.classList.contains('btnDel')) {
    e.target.closest('tr').remove();
    updateTotal();
  }
});

function updateTotal() {
  let total = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const qty = parseFloat(tr.querySelector('.qty').value) || 0;
    const price = parseFloat(tr.querySelector('.price').value) || 0;
    total += qty * price;
  });
  totalText.textContent = formatRupiah(total);
}

document.getElementById('formPembelian').addEventListener('submit', async e => {
  e.preventDefault();
  const items = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const sku = tr.querySelector('.sku').value.trim();
    const name = tr.querySelector('.name').value.trim();
    const qty = parseFloat(tr.querySelector('.qty').value);
    const price = parseFloat(tr.querySelector('.price').value);
    if (sku && qty > 0) items.push({ sku, name, qty, price });
  });

  if (!items.length) return alert('Tambahkan minimal 1 item');

  const data = {
    supplier_name: e.target.supplier_name.value.trim(),
    note: e.target.note.value.trim(),
    items
  };

  const res = await fetch('api/purchase_create.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  const json = await res.json();

  if (json.ok) {
    alert('Pembelian tersimpan!');
    tbody.innerHTML = '';
    updateTotal();
    loadRiwayat();
  } else {
    alert('Gagal: ' + json.error);
  }
});

async function loadRiwayat() {
  const res = await fetch('api/purchase_list.php');
  const j = await res.json();
  const div = document.getElementById('riwayat');
  if (!j.ok) return div.textContent = 'Gagal memuat data.';

  let html = '<table class="table table-sm table-striped"><thead><tr><th>Invoice</th><th>Supplier</th><th>Total</th><th>Tanggal</th></tr></thead><tbody>';
  j.data.forEach(r => {
    html += `<tr><td>${r.invoice_code}</td><td>${r.supplier_name||'-'}</td><td>${formatRupiah(parseFloat(r.total))}</td><td>${r.created_at_wib}</td></tr>`;
  });
  html += '</tbody></table>';
  div.innerHTML = html;
}

loadRiwayat();
</script>
</body>
</html>
