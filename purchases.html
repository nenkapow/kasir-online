<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kasir Warung Alesha - Pembelian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .cell-sm { width: 120px; }
    .cell-md { width: 180px; }
    .text-muted-mini { font-size:.8rem; }
    .readonly { background:#f8f9fa; }

    /* Biar dropdown tidak ketahan overflow tabel */
    .table-responsive { overflow: visible !important; }
    #tblItems td { position: relative; }

    /* --- Picker Produk (default: desktop) --- */
    .pick { position: relative; }
    .pick .pick-input { padding-bottom:.35rem; }

    .pick .list-group{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 12px);
      width: 100%;
      max-height: 280px;
      overflow: auto;
      z-index: 1055;
      border-radius: .5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      background: #fff;
    }
    .pick .list-group::before{
      content:"";
      position:absolute;
      top:-12px; left:0; right:0; height:12px;
    }
    .pick .list-group-item { cursor:pointer; }

    /* --- Mobile: jadikan bottom sheet agar tidak kepotong --- */
    @media (max-width: 767.98px){
      .pick .list-group{
        position: fixed;
        left: 12px;
        right: 12px;
        top: auto;
        bottom: calc(env(safe-area-inset-bottom, 0) + 16px);
        width: auto;
        max-height: 60vh;
        overflow-y: auto;
        z-index: 2000;
        border-radius: .75rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.2);
        background: #fff;
      }
    }
  </style>
</head>

<body class="bg-light">
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Pembelian / Stok Masuk</span>
    <a class="btn btn-sm btn-light" href="index.html">Kembali</a>
  </div>
</nav>

<main class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header fw-bold">Input Pembelian</div>
    <div class="card-body">
      <form id="formPembelian" autocomplete="off">
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Supplier</label>
            <input type="text" name="supplier_name" class="form-control" placeholder="Nama supplier (opsional)" />
          </div>
          <div class="col-md-8">
            <label class="form-label">Catatan</label>
            <input type="text" name="note" class="form-control" placeholder="Catatan pembelian (opsional)" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center" id="tblItems">
            <thead class="table-light">
              <tr>
                <th class="cell-sm">SKU</th>
                <th>Nama Produk <small class="text-muted">(HJ aktif ditampilkan di bawah)</small></th>
                <th class="cell-sm">Qty</th>
                <th class="cell-md">Harga (Beli)</th>
                <th class="cell-md">Subtotal</th>
                <th class="cell-sm"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <button type="button" class="btn btn-outline-primary btn-sm" id="btnAdd">+ Tambah Item</button>
        <hr class="my-3" />
        <div class="d-flex justify-content-between">
          <h5>Total: <span id="totalText">Rp 0</span></h5>
          <button type="submit" class="btn btn-primary">Simpan Pembelian</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header fw-bold">Riwayat Pembelian Hari Ini</div>
    <div class="card-body">
      <div id="riwayat"></div>
    </div>
  </div>
</main>

<script>
  const tbody = document.querySelector('#tblItems tbody');
  const btnAdd = document.getElementById('btnAdd');
  const totalText = document.getElementById('totalText');
  const rupiah = n => 'Rp ' + Number(n||0).toLocaleString('id-ID');

  // cache pencarian biar hemat request
  const productCache = new Map();
  function searchProducts(q){
    q = (q||'').trim();
    if(productCache.has(q)) return Promise.resolve(productCache.get(q));
    return fetch('api/products.php?q='+encodeURIComponent(q))
      .then(r=>r.json())
      .then(j=>{
        if(!j.ok) throw new Error(j.error||'Gagal ambil produk');
        productCache.set(q, j.data||[]);
        return j.data||[];
      });
  }

  function makeRow(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input class="form-control form-control-sm sku readonly" readonly placeholder="SKU">
      </td>
      <td>
        <div class="pick">
          <input class="form-control form-control-sm pick-input" placeholder="Ketik SKU / Nama, lalu pilih">
          <div class="list-group d-none pick-list"></div>
        </div>
        <div class="text-start text-muted-mini mt-1 name-info"></div>
      </td>
      <td>
        <input type="number" min="1" step="1" class="form-control form-control-sm qty" value="1">
      </td>
      <td>
        <input type="number" min="0" step="1" class="form-control form-control-sm price" value="0">
      </td>
      <td class="subtotal text-end">Rp 0</td>
      <td><button type="button" class="btn btn-danger btn-sm btnDel">&times;</button></td>
    `;
    attachRowEvents(tr);
    return tr;
  }

  btnAdd.addEventListener('click', ()=> {
    tbody.appendChild(makeRow());
    updateTotal();
  });

  function attachRowEvents(tr){
    const pickInput = tr.querySelector('.pick-input');
    const pickList  = tr.querySelector('.pick-list');
    const skuEl     = tr.querySelector('.sku');
    const nameInfo  = tr.querySelector('.name-info');
    const qtyEl     = tr.querySelector('.qty');
    const priceEl   = tr.querySelector('.price');

    let timer=null;

    pickInput.addEventListener('input', e=>{
      const q = e.target.value;
      clearTimeout(timer);
      if(!q){ pickList.innerHTML=''; pickList.classList.add('d-none'); return; }
      timer=setTimeout(async ()=>{
        try{
          const rows = await searchProducts(q);
          if(!rows.length){ pickList.classList.add('d-none'); pickList.innerHTML=''; return; }
          pickList.innerHTML = rows.map(r=>`
            <button type="button" class="list-group-item list-group-item-action"
                    data-sku="${r.sku}" data-name="${r.name}" data-cost="${r.cost_price}" data-sell="${r.sell_price}">
              <div class="d-flex justify-content-between">
                <span><strong>${r.sku}</strong> — ${r.name}</span>
                <small class="text-muted">HJ: ${rupiah(r.sell_price)} • Stok ${r.stock}</small>
              </div>
            </button>
          `).join('');
          pickList.classList.remove('d-none');
        }catch(err){ console.warn(err); }
      }, 250);
    });

    // pilih dari list – default harga beli = cost_price terakhir
    pickList.addEventListener('click', (e)=>{
      const it = e.target.closest('button.list-group-item');
      if(!it) return;
      const sku  = it.dataset.sku;
      const name = it.dataset.name;
      const cost = Number(it.dataset.cost||0);
      const sell = Number(it.dataset.sell||0);

      skuEl.value = sku;
      pickInput.value = name;
      pickInput.classList.add('readonly');
      pickInput.readOnly = true;

      priceEl.value = cost; // HARGA BELI pakai MODAL terakhir
      nameInfo.textContent = `Harga Jual (aktif): ${rupiah(sell)}`;

      pickList.classList.add('d-none'); pickList.innerHTML='';
      recalcRow(tr);
      updateTotal();
    });

    // qty / price berubah -> subtotal
    [qtyEl, priceEl].forEach(el=>{
      el.addEventListener('input', ()=>{
        recalcRow(tr);
        updateTotal();
      });
    });

    // hapus baris
    tr.querySelector('.btnDel').addEventListener('click', ()=>{
      tr.remove();
      updateTotal();
    });

    // klik di luar -> tutup dropdown
    document.addEventListener('click', (ev)=>{
      if(!tr.contains(ev.target)){
        pickList.classList.add('d-none');
      }
    });
  }

  function recalcRow(tr){
    const qty = Number(tr.querySelector('.qty').value||0);
    const price = Number(tr.querySelector('.price').value||0);
    tr.querySelector('.subtotal').textContent = rupiah(qty*price);
  }

  function updateTotal(){
    let total = 0;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const qty = Number(tr.querySelector('.qty').value||0);
      const price = Number(tr.querySelector('.price').value||0);
      total += qty*price;
    });
    totalText.textContent = rupiah(total);
  }

  // submit
  document.getElementById('formPembelian').addEventListener('submit', async e => {
    e.preventDefault();
    const items = [];
    tbody.querySelectorAll('tr').forEach(tr => {
      const sku   = tr.querySelector('.sku').value.trim();
      const name  = tr.querySelector('.pick-input').value.trim();
      const qty   = Number(tr.querySelector('.qty').value||0);
      const price = Number(tr.querySelector('.price').value||0);
      if (sku && qty>0) items.push({ sku, name, qty, price });
    });
    if (!items.length) return alert('Tambahkan minimal 1 item dan pilih produk dari daftar.');

    const data = {
      supplier_name: e.target.supplier_name.value.trim(),
      note: e.target.note.value.trim(),
      items
    };

    try{
      const res = await fetch('api/purchase_create.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if(!json.ok) throw new Error(json.error||'Gagal simpan');
      alert('Pembelian tersimpan!');
      tbody.innerHTML=''; updateTotal();
      loadRiwayat();
    }catch(err){
      alert('Gagal: '+err.message);
    }
  });

  // riwayat
  async function loadRiwayat(){
    try{
      const res = await fetch('api/purchase_list.php');
      const j = await res.json();
      const div = document.getElementById('riwayat');
      if(!j.ok){ div.textContent='Gagal memuat data.'; return; }
      let html = '<table class="table table-sm table-striped"><thead><tr><th>Invoice</th><th>Supplier</th><th>Total</th><th>Tanggal</th></tr></thead><tbody>';
      j.data.forEach(r=>{
        html += `<tr><td>${r.invoice_code}</td><td>${r.supplier_name||'-'}</td><td>${rupiah(Number(r.total))}</td><td>${r.created_at_wib}</td></tr>`;
      });
      html += '</tbody></table>';
      div.innerHTML = html;
    }catch(err){}
  }
  loadRiwayat();

  // mulai dengan 1 baris kosong
  btnAdd.click();
</script>
</body>
</html>
